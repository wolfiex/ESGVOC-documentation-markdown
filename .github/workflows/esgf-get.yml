name: Build ESGF Docs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 0'  # every Sunday at 02:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Sparse checkout only the docs/source folder
    - name: Checkout docs/source from ESGF-vocab
      run: |
        git init esgf-vocab
        cd esgf-vocab
        git remote add origin https://github.com/ESGF/esgf-vocab.git
        git config core.sparseCheckout true
        echo "docs/source/*" >> .git/info/sparse-checkout
        git fetch --depth=1 origin main
        git checkout main
        cd ..

    # 2. Setup Python
    - name: Set up Python
      uses: actions/setup-python@v4

    # 3. Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mkdocs mkdocstrings mkdocs-material
        pip install sphinx sphinx-markdown-builder myst-parser pymdown-extensions autodoc_pydantic myst-nb

        pip install esgvoc

    # 4. Copy the pulled docs into build folder
    - name: Prepare docs folder
      run: |
        mkdir -p build_md
        cp -R esgf-vocab/docs/source/* build_md/

    # 5. Update mkdocs.yml to include mkdocstrings plugin
    - name: Update mkdocs.yml
      run: |
        if ! grep -q "mkdocstrings" mkdocs.yml; then
          echo -e "\nplugins:\n  - mkdocstrings" >> mkdocs.yml
        fi

    # 6. Run Sphinx Markdown build
    - name: Generate Markdown from Sphinx
      run: |
        sphinx-build -b markdown build_md/ build_md_out/

    # 7. Commit and push generated Markdown back to your repo
    - name: Commit and push generated Markdown
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git add build_md_out/ mkdocs.yml
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update generated Markdown docs [skip ci]"
          git push origin HEAD:${{ github.ref }}
